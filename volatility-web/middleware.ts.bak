import { NextResponse } from "next/server"
import type { NextRequest } from "next/server"

/**
 * Azure AD Authentication Middleware using NextAuth.js
 * Provides enterprise-grade authentication with Azure Active Directory
 */

export default function middleware(req: NextRequest) {
  // Temporarily bypass authentication for development
  // TODO: Re-enable authentication by uncommenting the auth wrapper
  return NextResponse.next()
  
  /* Original auth-based middleware - uncomment when auth is needed:
  
  const { pathname } = req.nextUrl

  // Allow access to auth pages, API routes, and static assets
  if (
    pathname.startsWith("/auth/") ||
    pathname.startsWith("/api/auth/") ||
    pathname.startsWith("/_next/") ||
    pathname.startsWith("/static/") ||
    pathname === "/api/health" ||
    pathname === "/health" ||
    pathname === "/favicon.ico" ||
    pathname.includes('.') && !pathname.endsWith('/') // files with extensions
  ) {
    return NextResponse.next()
  }

  // Check if user is authenticated
  if (!req.auth) {
    // Redirect to sign-in page with callback URL
    const signInUrl = new URL("/auth/signin", req.url)
    signInUrl.searchParams.set("callbackUrl", pathname)
    return NextResponse.redirect(signInUrl)
  }

  // Optional: Add additional authorization checks here
  // For example, check user roles or tenant permissions
  const user = req.auth.user
  if (user) {
    // Add custom headers for downstream services
    const requestHeaders = new Headers(req.headers)
    requestHeaders.set('x-user-id', user.id || '')
    requestHeaders.set('x-user-email', user.email || '')
    requestHeaders.set('x-user-name', user.name || '')
    
    // Add tenant information if available
    if ((req.auth as any).tenantId) {
      requestHeaders.set('x-tenant-id', (req.auth as any).tenantId)
    }

    return NextResponse.next({
      request: {
        headers: requestHeaders,
      },
    })
  }

  return NextResponse.next()
  */
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api/health (health checks)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
}